<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Untitled</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <style type="text/css">body { line-height: 1.3em; }
p { line-height: 1.5em; }
img {
display: block;
margin-left: auto;
margin-right: auto;
width: 66%;
}
h1, h2, h3 {
padding: 1em 1em; border-left: 0.5em solid #000;
background: #f4f4f4;
}
h1.title {
all: initial;
font-size: 1em;
border-left: 3em solid #000;
padding: 0em 0.5em 0em 0.5em;
font-weight: bold;
}
p.author, h2.author {
all: initial;
font-size: 1em;
border-left: 0.5em solid #000;
padding: 0em 0.5em 0em 0.5em;
font-weight: bold;
}
p.date, h3.date {
all: initial;
font-size: 1em;
border-left: 0.5em solid #000;
border-right: 10em solid #000;
padding: 0em 0.5em 0em 0.5em;
font-weight: bold;
}
p.caption {
text-align: center;
font-weight: bold;
}
table {
width: 85%;
margin: auto;
border-collapse: collapse;
border-spacing: 4px;
}
pre {
width: 85%;
padding: 0.5em 1em;
margin: auto;
border:1px solid #333;
padding: 4px;
}
td, th {
border-collapse: collapse;
border:1px solid #333;
}
div.success {
width: 90%;
margin: 0.5em 1em;
margin-left: auto;
margin-right: auto;
padding: 0.5em 1em;
border: dashed 2px #408040;
background-color: #e0FFe0;
}
div.warning {
width: 90%;
margin: 0.5em 1em;
margin-left: auto;
margin-right: auto;
padding: 0.5em 1em;
border: dashed 2px #807060;
background-color: #FFF8E8;
}
div.danger {
width: 90%;
margin: 0.5em 1em;
margin-left: auto;
margin-right: auto;
padding: 0.5em 1em;
border: dashed 2px #FF0000;
background-color: #FFE0E0;
}
div.info {
width: 90%;
margin: 0.5em 1em;
margin-left: auto;
margin-right: auto;
padding: 0.5em 1em;
border: dashed 2px #404080;
background-color: #e8e8FF;
}
div.pageref {
padding: 0.5em 1em;
margin: 2em 0;
color: #232323;
background: #fff8e8;
border-left: solid 10px #ffc06e;
}
code {

padding: 0.2em 0.2em 0.2em 0.2em; background: #f0f0f0;
border: solid 1px #808080;
border-radius: 0.2em;
}
pre code {
background: #ffffff;
border: none;
}</style>
</head>
<body>
<nav id="TOC">
<ul>
<li><a href="#timer">Timer</a><ul>
<li><a href="#pin-assignment">Pin assignment</a></li>
<li><a href="#initialize-and-start-end">Initialize and start, end</a></li>
<li><a href="#timer-interrupt">Timer interrupt</a></li>
<li><a href="#pwm-output">PWM output</a></li>
</ul></li>
</ul>
</nav>
<h1 id="timer">Timer</h1>
<p>Hardware timers that use 16-bit counters (TIMER0 … 4) are available.</p>
<p>This timer can be used as a peripheral, such as a PWM output, or it can be used as a hardware timer for software processing.</p>
<h2 id="pin-assignment">Pin assignment</h2>
<table>
<thead>
<tr class="header">
<th>Timer Name</th>
<th>Primary pin assgin</th>
<th>Sub</th>
<th>Sub2</th>
<th>explanation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>TIMER0</td>
<td>8, 9, 10</td>
<td>2,3,4</td>
<td></td>
<td>General-purpose timer function available</td>
</tr>
<tr class="even">
<td>TIMER1</td>
<td>11</td>
<td>5</td>
<td></td>
<td>PWM output only</td>
</tr>
<tr class="odd">
<td>TIMER2</td>
<td>12</td>
<td>6</td>
<td>DO0*</td>
<td>PWM output only</td>
</tr>
<tr class="even">
<td>TIMER3</td>
<td>13</td>
<td>7</td>
<td>DO1*</td>
<td>PWM output only</td>
</tr>
<tr class="odd">
<td>TIMER4</td>
<td>17</td>
<td>8</td>
<td></td>
<td>PWM output only</td>
</tr>
</tbody>
</table>
<div class="info">
<p>It can be changed to a sub-allocation with the peripheral <code>API vAHI_TimerSetLocation()</code>.</p>
<ul>
<li>TIMER2 and 3 can be reassigned to DO0 and 1. However, for these ports, the TWELITE wireless microcontroller may not start normally unless they are at the Vcc level when power is turned on.</li>
</ul>
</div>
<div class="warning">
<p>In TWELITE RED, there are more PWM output systems, but the standard response in TWELITE NET is TIMER0..4.</p>
</div>
<h2 id="initialize-and-start-end">Initialize and start, end</h2>
<p>Declare the ports that will not be used by the Timer by referring to the peripheral manual in advance. If this declaration is not made, the corresponding port will not be available as a general-purpose IO port after the Timer is initialized.</p>
<p>In the following example, bit0, 1, and 2 are set. This releases all PWM pins used of TIMER0 for general-purpose IO.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb1-1" title="1">vAHI_TimerFineGrainDIOControl(<span class="bn">0x7</span>);</a></code></pre></div>
<blockquote>
<h4 id="the-parameter-of-vahi_timerfinegraindiocontrol">the parameter of vAHI_TimerFineGrainDIOControl()</h4>
</blockquote>
<table>
<thead>
<tr class="header">
<th><br>Bit</th>
<th>Timer Input/Output</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>TIMER 0 gate/event input</td>
</tr>
<tr class="even">
<td>1</td>
<td>TIMER 0 capture input</td>
</tr>
<tr class="odd">
<td>2</td>
<td>TIMER 0 PWM output</td>
</tr>
<tr class="even">
<td>3</td>
<td>TIMER 1 PWM output</td>
</tr>
<tr class="odd">
<td>4</td>
<td>TIMER 2 PWM output</td>
</tr>
<tr class="even">
<td>5</td>
<td>TIMER 3 PWM output</td>
</tr>
<tr class="odd">
<td>6</td>
<td>TIMER 4 PWM output</td>
</tr>
<tr class="even">
<td>7</td>
<td>reserved</td>
</tr>
</tbody>
</table>
<p>Next, the initialization structure <a href="timerraiburari/tstimercontext.html"><code>tsTimerContext</code></a>for the Timer library is statically allocated and configured.必要なタイマーの周波数に対して適切な PreScale を選択するようにします。</p>
<div class="info">
<p>The prescale (<code>u8PreScale</code>) selects a smaller value in most cases for the required period (frequency).</p>
<p>The Timer prescales the counter value at 16Mhz, and the count value (Ct) for one cycle is given by the following equation</p>
<pre><code>Ct = 16,000,000 / 2^p / hz
    p  : prescale value
    hz : Timer cycle</code></pre>
<p>Set this <code>Ct</code> value so that it does not exceed the maximum number of 16 bits (65535). For example, if you want a 64Hz timer, <code>p=2</code> gives <code>Ct = 62500</code>, <code>p=4</code> gives <code>Ct = 15625</code>. If you need a PWM output with a more accurate duty ratio, choose a slightly smaller <code>p=2</code>, but if you simply need a timer for software, <code>p=4</code> makes no difference.</p>
</div>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb3-1" title="1">tsTimerContext sTimerApp; <span class="co">// global or static allocation</span></a>
<a class="sourceLine" id="cb3-2" title="2"></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="co">// set 64ticks/sec</span></a>
<a class="sourceLine" id="cb3-4" title="4">memset(&amp;sTimerApp, <span class="dv">0</span>, <span class="kw">sizeof</span>(tsTimerContext));</a>
<a class="sourceLine" id="cb3-5" title="5">sTimerApp.u8Device = E_AHI_DEVICE_TIMER0;</a>
<a class="sourceLine" id="cb3-6" title="6">sTimerApp.u16Hz = <span class="dv">64</span>;</a>
<a class="sourceLine" id="cb3-7" title="7">sTimerApp.u8PreScale = <span class="dv">4</span>; <span class="co">// 15625ct@2^4</span></a></code></pre></div>
<p>Finally, start the Timer.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb4-1" title="1">vTimerConfig(&amp;sTimerApp); <span class="co">// initialize</span></a>
<a class="sourceLine" id="cb4-2" title="2">vTimerStart(&amp;sTimerApp); <span class="co">// start timer</span></a></code></pre></div>
<p>To stop the timer temporarily, call <code>vTimerStop()</code>. To disable it completely, call <code>vTimerDisable()</code>.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb5-1" title="1"><span class="co">// just stop the timer</span></a>
<a class="sourceLine" id="cb5-2" title="2">vTimerStop(&amp;sTimerApp);</a>
<a class="sourceLine" id="cb5-3" title="3">...</a>
<a class="sourceLine" id="cb5-4" title="4"><span class="co">// restart</span></a>
<a class="sourceLine" id="cb5-5" title="5">vTimerStart(&amp;sTimerApp);</a>
<a class="sourceLine" id="cb5-6" title="6">...</a>
<a class="sourceLine" id="cb5-7" title="7"><span class="co">// now, disable timer completely</span></a>
<a class="sourceLine" id="cb5-8" title="8">vTimerStop(&amp;sTimerApp);</a>
<a class="sourceLine" id="cb5-9" title="9">vTimerDisable(&amp;sTimerApp);</a></code></pre></div>
<h2 id="timer-interrupt">Timer interrupt</h2>
<p>The <code>u8DeviceID</code> parameter of <code>ToCoNet_u8HwInt()</code> and <code>ToCoNet_vHwEvent()</code> takes <code>E_AHI_DEVICE_TIMER0</code> to <code>E_AHI_DEVICE_TIMER4</code>.</p>
<div class="warning">
<p>As the interrupt frequency increases, the overhead of processing hard interrupts and events becomes non-negligible.</p>
<ul>
<li>Disable unnecessary timer interrupts.
<ul>
<li>Set <code>bDisableInt</code> of <code>tsTimerContext</code> to <code>TRUE</code>.</li>
</ul></li>
<li>Handled by interrupt processing only, no hard events are generated.
<ul>
<li>To <code>return</code> an interrupt handler with <code>TRUE</code>.</li>
</ul></li>
</ul>
</div>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb6-1" title="1"><span class="co">// hardware interrupt (return quickly!)</span></a>
<a class="sourceLine" id="cb6-2" title="2">uint8 cbToCoNet_u8HwInt(</a>
<a class="sourceLine" id="cb6-3" title="3">        uint32 u32DeviceId, </a>
<a class="sourceLine" id="cb6-4" title="4">        uint32 u32ItemBitmap) {</a>
<a class="sourceLine" id="cb6-5" title="5">    uint8 u8handled = FALSE;</a>
<a class="sourceLine" id="cb6-6" title="6"></a>
<a class="sourceLine" id="cb6-7" title="7">    <span class="cf">switch</span> (u32DeviceId) {</a>
<a class="sourceLine" id="cb6-8" title="8">    <span class="cf">case</span> E_AHI_DEVICE_TIMER0:</a>
<a class="sourceLine" id="cb6-9" title="9">        _C {</a>
<a class="sourceLine" id="cb6-10" title="10">            <span class="dt">static</span> bool_t b;</a>
<a class="sourceLine" id="cb6-11" title="11">            b = !b;</a>
<a class="sourceLine" id="cb6-12" title="12">            vPortSet_TrueAsLo(PORT_DO1, b);</a>
<a class="sourceLine" id="cb6-13" title="13">            </a>
<a class="sourceLine" id="cb6-14" title="14">            u8handled = FALSE; <span class="co">// if TRUE, no HwEvent follows.</span></a>
<a class="sourceLine" id="cb6-15" title="15">        }</a>
<a class="sourceLine" id="cb6-16" title="16">        <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb6-17" title="17">    }</a>
<a class="sourceLine" id="cb6-18" title="18">}</a>
<a class="sourceLine" id="cb6-19" title="19"></a>
<a class="sourceLine" id="cb6-20" title="20"><span class="co">// hardware event (in the application loop)</span></a>
<a class="sourceLine" id="cb6-21" title="21"><span class="co">//   where we can make a bigger job, like RF transmit.</span></a>
<a class="sourceLine" id="cb6-22" title="22"><span class="dt">void</span> cbToCoNet_vHwEvent(</a>
<a class="sourceLine" id="cb6-23" title="23">        uint32 u32DeviceId,</a>
<a class="sourceLine" id="cb6-24" title="24">        uint32 u32ItemBitmap) {</a>
<a class="sourceLine" id="cb6-25" title="25">        </a>
<a class="sourceLine" id="cb6-26" title="26">    <span class="cf">switch</span> (u32DeviceId) {</a>
<a class="sourceLine" id="cb6-27" title="27">    <span class="cf">case</span> E_AHI_DEVICE_TIMER0:</a>
<a class="sourceLine" id="cb6-28" title="28">        vPutChar(&amp;sSerStream, <span class="ch">&#39;x&#39;</span>); <span class="co">// put x every tick</span></a>
<a class="sourceLine" id="cb6-29" title="29">        <span class="cf">if</span> (...) {</a>
<a class="sourceLine" id="cb6-30" title="30">            ...</a>
<a class="sourceLine" id="cb6-31" title="31">            ToCoNet_bMacTxReq(...); <span class="co">// send a packt</span></a>
<a class="sourceLine" id="cb6-32" title="32">        }</a>
<a class="sourceLine" id="cb6-33" title="33">        <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb6-34" title="34">    }   </a>
<a class="sourceLine" id="cb6-35" title="35">    </a>
<a class="sourceLine" id="cb6-36" title="36">}</a></code></pre></div>
<h2 id="pwm-output">PWM output</h2>
<p>The PWM output can be set as the output of the Timer.</p>
<div class="info">
<p>In order to improve the accuracy of the Duty ratio, it is recommended that the prescale value described above be kept small enough.</p>
</div>
<p>The following settings are required to have PWM output.</p>
<ul>
<li>Set <code>bPWMOut</code> of <code>tsTimerContext</code> to <code>TRUE</code>.</li>
<li>Set <code>u16duty</code> of <code>tsTimerContext</code> to a value of 0..1024.</li>
<li>Output is not disabled by <code>vAHI_TimerFineGrainDIOControl()</code>.</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb7-1" title="1">tsTimerContext sTimerPWM; <span class="co">// global or static allocation</span></a>
<a class="sourceLine" id="cb7-2" title="2"></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="co">// initialize</span></a>
<a class="sourceLine" id="cb7-4" title="4">memset(&amp;sTimerPWM, <span class="dv">0</span>, <span class="kw">sizeof</span>(tsTimerContext));</a>
<a class="sourceLine" id="cb7-5" title="5">sTimerPWM.u8Device = E_AHI_DEVICE_TIMER1;</a>
<a class="sourceLine" id="cb7-6" title="6">sTimerPWM.u16Hz = <span class="dv">1000</span>; <span class="co">// 1Khz</span></a>
<a class="sourceLine" id="cb7-7" title="7">sTimerPWM.u8PreScale = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb7-8" title="8">sTimerPWM.u16duty = <span class="dv">512</span>; <span class="co">// 50%</span></a>
<a class="sourceLine" id="cb7-9" title="9">sTimerPWM.bPWMout = TRUE; <span class="co">// PWM out</span></a>
<a class="sourceLine" id="cb7-10" title="10">sTimerPWM.bDisableInt = TRUE; <span class="co">// no interrupt (for CPU save)</span></a>
<a class="sourceLine" id="cb7-11" title="11"><span class="co">// start</span></a>
<a class="sourceLine" id="cb7-12" title="12">vTimerConfig(&amp;sTimerPWM);</a>
<a class="sourceLine" id="cb7-13" title="13">vTimerStart(&amp;sTimerPWM);</a>
<a class="sourceLine" id="cb7-14" title="14"></a>
<a class="sourceLine" id="cb7-15" title="15">...</a>
<a class="sourceLine" id="cb7-16" title="16"><span class="co">// change duty</span></a>
<a class="sourceLine" id="cb7-17" title="17">sTimerPWM.u16Duty = <span class="dv">256</span>; <span class="co">// set new duty ratio</span></a>
<a class="sourceLine" id="cb7-18" title="18">vTimerStart(&amp;sTimerPWM); <span class="co">// just start again to change duty</span></a></code></pre></div>
</body>
</html>
