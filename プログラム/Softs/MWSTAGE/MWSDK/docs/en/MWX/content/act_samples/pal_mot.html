<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Mono Wireless Inc." />
  <title>PAL_MOT-fifo</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <style type="text/css">body { line-height: 1.3em; }
p { line-height: 1.5em; }
img {
display: block;
margin-left: auto;
margin-right: auto;
width: 66%;
}
h1, h2, h3 {
padding: 1em 1em; border-left: 0.5em solid #000;
background: #f4f4f4;
}
h1.title {
all: initial;
font-size: 1em;
border-left: 3em solid #000;
padding: 0em 0.5em 0em 0.5em;
font-weight: bold;
}
p.author, h2.author {
all: initial;
font-size: 1em;
border-left: 0.5em solid #000;
padding: 0em 0.5em 0em 0.5em;
font-weight: bold;
}
p.date, h3.date {
all: initial;
font-size: 1em;
border-left: 0.5em solid #000;
border-right: 10em solid #000;
padding: 0em 0.5em 0em 0.5em;
font-weight: bold;
}
p.caption {
text-align: center;
font-weight: bold;
}
table {
width: 85%;
margin: auto;
border-collapse: collapse;
border-spacing: 4px;
}
pre {
width: 85%;
padding: 0.5em 1em;
margin: auto;
border:1px solid #333;
padding: 4px;
}
td, th {
border-collapse: collapse;
border:1px solid #333;
}
div.success {
width: 90%;
margin: 0.5em 1em;
margin-left: auto;
margin-right: auto;
padding: 0.5em 1em;
border: dashed 2px #408040;
background-color: #e0FFe0;
}
div.warning {
width: 90%;
margin: 0.5em 1em;
margin-left: auto;
margin-right: auto;
padding: 0.5em 1em;
border: dashed 2px #807060;
background-color: #FFF8E8;
}
div.danger {
width: 90%;
margin: 0.5em 1em;
margin-left: auto;
margin-right: auto;
padding: 0.5em 1em;
border: dashed 2px #FF0000;
background-color: #FFE0E0;
}
div.info {
width: 90%;
margin: 0.5em 1em;
margin-left: auto;
margin-right: auto;
padding: 0.5em 1em;
border: dashed 2px #404080;
background-color: #e8e8FF;
}
div.pageref {
padding: 0.5em 1em;
margin: 2em 0;
color: #232323;
background: #fff8e8;
border-left: solid 10px #ffc06e;
}
code {

padding: 0.2em 0.2em 0.2em 0.2em; background: #f0f0f0;
border: solid 1px #808080;
border-radius: 0.2em;
}
pre code {
background: #ffffff;
border: none;
}</style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">PAL_MOT-fifo</h1>
<p class="author">Mono Wireless Inc.</p>
</header>
<nav id="TOC">
<ul>
<li><a href="#pal_mot-fifo">PAL_MOT-fifo</a><ul>
<li><a href="#act-features">ACT Features</a></li>
<li><a href="#how-to-use-act">how to use act</a><ul>
<li><a href="#required-twelite">Required TWELITE</a></li>
</ul></li>
<li><a href="#explanation-of-act">Explanation of ACT</a><ul>
<li><a href="#include">Include</a></li>
<li><a href="#setup">setup()</a></li>
<li><a href="#begin">begin()</a></li>
<li><a href="#sleepnow">sleepNow()</a></li>
<li><a href="#wakeup">wakeup()</a></li>
<li><a href="#loop">loop()</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
<h1 id="pal_mot-fifo">PAL_MOT-fifo</h1>
<p><a target=_blank href="https://mono-wireless.com/jp/products/twelite-pal/sense/amb-pal.html">MOTION SENSE PAL</a> is used to acquire sensor values.</p>
<div class="success">
<p>The ACT of the ACT includes the following.</p>
<ul>
<li>Sending and receiving wireless packets</li>
<li>Interactive settings mode configuration - <a href="../settings/stg_std.html">&lt;STG_STD&gt;</a></li>
<li>State transition control by state machine - <a href="../api-reference/classes/smsimple-suttomashin.html">&lt;SM_SIMPLE&gt;</a></li>
<li><a href="../boards/pal/pal_mot.html">&lt;PAL_MOT&gt;</a> or <a href="../boards/cue.html">&lt;CUE&gt;</a>Board operation with board BEHAVIOR</li>
</ul>
</div>
<h2 id="act-features">ACT Features</h2>
<ul>
<li>Uses the motion sensor PAL MOTION SENSE PAL to continuously measure the acceleration of the accelerometer and transmit it wirelessly.</li>
<li>Use the sleep function, to operate on coin cell batteries.</li>
</ul>
<h2 id="how-to-use-act">how to use act</h2>
<h3 id="required-twelite">Required TWELITE</h3>
<table>
<thead>
<tr class="header">
<th>Role</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Parent Node</td>
<td><a target=_blank href="https://mono-wireless.com/jp/products/MoNoStick/">MONOSTICK BLUE or RED</a><br>Act <a href="parent_monostick.html">Parent_MONOSTICK</a> to work.</td>
</tr>
<tr class="even">
<td>Child Node</td>
<td><a target=_blank href="https://mono-wireless.com/jp/products/twelite-pal/BnR/index.html">BLUE PAL or RED PAL</a> + <a target=_blank href="https://mono-wireless.com/jp/products/twelite-pal/sense/amb-pal.html">Motion Sensor PAL MOTION SENSE PAL</a></td>
</tr>
</tbody>
</table>
<h2 id="explanation-of-act">Explanation of ACT</h2>
<h3 id="include">Include</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb1-1" title="1"><span class="pp">#include </span><span class="im">&lt;TWELITE&gt;</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="pp">#include </span><span class="im">&lt;NWK_SIMPLE&gt;</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="pp">#include </span><span class="im">&lt;PAL_&gt;</span></a></code></pre></div>
<p> Board BEHAVIOR <a href="../boards/pal/pal_mot.html"><code>&lt;PAL_MOT&gt;</code></a> is included.</p>
<h3 id="setup">setup()</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb2-1" title="1"><span class="dt">void</span> setup() {</a>
<a class="sourceLine" id="cb2-2" title="2">    <span class="co">/*** SETUP section */</span></a>
<a class="sourceLine" id="cb2-3" title="3">    <span class="co">// board</span></a>
<a class="sourceLine" id="cb2-4" title="4">    <span class="kw">auto</span>&amp;&amp; brd = the_twelite.board.use&lt;PAL_MOT&gt;();</a>
<a class="sourceLine" id="cb2-5" title="5">    brd.set_led(LED_TIMER::BLINK, <span class="dv">100</span>);</a>
<a class="sourceLine" id="cb2-6" title="6"></a>
<a class="sourceLine" id="cb2-7" title="7">    <span class="co">// the twelite main class</span></a>
<a class="sourceLine" id="cb2-8" title="8">    the_twelite</a>
<a class="sourceLine" id="cb2-9" title="9">        &lt;&lt; TWENET::appid(APP_ID)     </a>
<a class="sourceLine" id="cb2-10" title="10">        &lt;&lt; TWENET::channel(CHANNEL);</a>
<a class="sourceLine" id="cb2-11" title="11"></a>
<a class="sourceLine" id="cb2-12" title="12">    <span class="co">// Register Network</span></a>
<a class="sourceLine" id="cb2-13" title="13">    <span class="kw">auto</span>&amp;&amp; nwk = the_twelite.network.use&lt;NWK_SIMPLE&gt;();</a>
<a class="sourceLine" id="cb2-14" title="14">    nwk &lt;&lt; NWK_SIMPLE::logical_id(<span class="bn">0xFE</span>); </a>
<a class="sourceLine" id="cb2-15" title="15">    </a>
<a class="sourceLine" id="cb2-16" title="16">    <span class="co">/*** </span><span class="re">BEGIN</span><span class="co"> section */</span></a>
<a class="sourceLine" id="cb2-17" title="17">    the_twelite.begin(); <span class="co">// start twelite!</span></a>
<a class="sourceLine" id="cb2-18" title="18">    brd.sns_MC3630.begin(SnsMC3630::Settings(</a>
<a class="sourceLine" id="cb2-19" title="19">        SnsMC3630::MODE_LP_14HZ, SnsMC3630::RANGE_PLUS_MINUS_4G));</a>
<a class="sourceLine" id="cb2-20" title="20"></a>
<a class="sourceLine" id="cb2-21" title="21">    <span class="co">/*** INIT message */</span></a>
<a class="sourceLine" id="cb2-22" title="22">    Serial &lt;&lt; <span class="st">&quot;--- PAL_MOT(Cont):&quot;</span> &lt;&lt; FOURCHARS </a>
<a class="sourceLine" id="cb2-23" title="23">                 &lt;&lt; <span class="st">&quot; ---&quot;</span> &lt;&lt; mwx::crlf;</a>
<a class="sourceLine" id="cb2-24" title="24">}</a></code></pre></div>
<p>First, register the board BEHAVIOR <code>&lt;PAL_MOT&gt;</code>. When the board BEHAVIOR is initialized, the sensors and DIOs are initialized. The reason for doing this first is that it is common to check the status of the board’s DIP SW, etc., and then configure the network settings, etc.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">auto</span>&amp;&amp; brd = the_twelite.board.use&lt;PAL_MOT&gt;();</a>
<a class="sourceLine" id="cb3-2" title="2"></a>
<a class="sourceLine" id="cb3-3" title="3">u8ID = (brd.get_DIPSW_BM() &amp; <span class="bn">0x07</span>) + <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb3-4" title="4"><span class="cf">if</span> (u8ID == <span class="dv">0</span>) u8ID = <span class="bn">0xFE</span>; <span class="co">// 0 is to 0xFE</span></a></code></pre></div>
<p>Here, 3 bits of the 4-bit DIP SW on the board are read and set as the Child Node ID. 0 means no ID (<code>0xFE</code>).</p>
<p>Set the LED settings. Here the ON/OFF blinking is set to blink every 10ms (in an application that sleeps and has a short wake-up time, this is almost equivalent to setting the LED to turn on during wake-up).</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb4-1" title="1">    brd.set_led(LED_TIMER::BLINK, <span class="dv">10</span>); <span class="co">// blink (on 10ms/ off 10ms)</span></a></code></pre></div>
<h4 id="accelerometer-initialization">Accelerometer initialization</h4>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb5-1" title="1">    brd.sns_MC3630.begin(SnsMC3630::Settings(</a>
<a class="sourceLine" id="cb5-2" title="2">        SnsMC3630::MODE_LP_14HZ, SnsMC3630::RANGE_PLUS_MINUS_4G));</a></code></pre></div>
<p>Starts accelerometer measurement. The accelerometer settings (<code>SnsMC3630::Settings</code>) specify the measurement frequency and measurement range. Here we use 14HZ measurement (<code>SnsMC3630::MODE_LP_14HZ</code>) with ±4G range (<code>SnsMC3630::RANGE_PLUS_MINUS_4G</code>).</p>
<p>Once started, the accelerometer takes 14 measurements per second and the values are stored in a FIFO queue inside the sensor. The sensor is notified when 28 measurements have been taken.</p>
<h3 id="begin">begin()</h3>
<p>The <code>begin()</code> function exits the <code>setup()</code> function (after which TWENET is initialized) and is called just before the first <code>loop()</code>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb6-1" title="1"><span class="dt">void</span> begin() {</a>
<a class="sourceLine" id="cb6-2" title="2">    sleepNow(); <span class="co">// the first time is just sleeping.</span></a>
<a class="sourceLine" id="cb6-3" title="3">}</a></code></pre></div>
<p>Call <code>sleepNow()</code> after <code>setup()</code> ends to perform the first sleep.</p>
<h3 id="sleepnow">sleepNow()</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb7-1" title="1"><span class="dt">void</span> sleepNow() {</a>
<a class="sourceLine" id="cb7-2" title="2">    pinMode(PAL_MOT::PIN_SNS_INT, WAKE_FALLING);</a>
<a class="sourceLine" id="cb7-3" title="3">    the_twelite.sleep(<span class="dv">60000</span>, <span class="kw">false</span>);</a>
<a class="sourceLine" id="cb7-4" title="4">}</a></code></pre></div>
<p>Before going to sleep, set up an interrupt for the accelerometer’s DIO pin, which is generated when the FIFO queue reaches a certain number. The second parameter is <code>PIN_MODE::WAKE_FALLING</code>. This is a setting to wake up when the pin state changes from HIGH to LOW.</p>
<p>The third line executes sleep with <code>the_twelite.sleep()</code>. The parameter 60000 is the wake-up setting required to reset the watchdog on the TWELITE PAL board. If not reset, a hard reset will be performed after 60 seconds.</p>
<h3 id="wakeup">wakeup()</h3>
<p>When the accelerometer wakes up from sleep due to a FIFO interrupt from the accelerometer, <code>wakeup()</code> is called. After that, <code>loop()</code> is called each time. Before <code>wakeup()</code>, each peripheral such as UART and devices on the board are woken up (e.g. resetting the watchdog timer). For example, it restarts the LED lighting control.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb8-1" title="1"><span class="dt">void</span> wakeup() {</a>
<a class="sourceLine" id="cb8-2" title="2">    Serial &lt;&lt; <span class="st">&quot;--- PAL_MOT(Cont):&quot;</span> &lt;&lt; FOURCHARS</a>
<a class="sourceLine" id="cb8-3" title="3">           &lt;&lt; <span class="st">&quot; wake up ---&quot;</span> &lt;&lt; mwx::crlf;</a>
<a class="sourceLine" id="cb8-4" title="4"></a>
<a class="sourceLine" id="cb8-5" title="5">    b_transmit = <span class="kw">false</span>;</a>
<a class="sourceLine" id="cb8-6" title="6">    txid[<span class="dv">0</span>] = <span class="bn">0xFFFF</span>;</a>
<a class="sourceLine" id="cb8-7" title="7">    txid[<span class="dv">1</span>] = <span class="bn">0xFFFF</span>;</a>
<a class="sourceLine" id="cb8-8" title="8">}</a></code></pre></div>
<p>Here we are initializing variables to be used in <code>loop()</code>.</p>
<h3 id="loop">loop()</h3>
<p>Here, the acceleration information stored in the FIFO queue in the accelerometer is retrieved and packet transmission is performed based on this information. After the packet transmission is completed, sleep is executed again.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb9-1" title="1"><span class="dt">void</span> loop() {</a>
<a class="sourceLine" id="cb9-2" title="2">    <span class="kw">auto</span>&amp;&amp; brd = the_twelite.board.use&lt;PAL_MOT&gt;();</a>
<a class="sourceLine" id="cb9-3" title="3"></a>
<a class="sourceLine" id="cb9-4" title="4">    <span class="cf">if</span> (!b_transmit) {</a>
<a class="sourceLine" id="cb9-5" title="5">        <span class="cf">if</span> (!brd.sns_MC3630.available()) {</a>
<a class="sourceLine" id="cb9-6" title="6">            Serial &lt;&lt; <span class="st">&quot;..sensor is not available.&quot;</span> </a>
<a class="sourceLine" id="cb9-7" title="7">                    &lt;&lt; mwx::crlf &lt;&lt; mwx::flush;</a>
<a class="sourceLine" id="cb9-8" title="8">            sleepNow();</a>
<a class="sourceLine" id="cb9-9" title="9">        }</a>
<a class="sourceLine" id="cb9-10" title="10"></a>
<a class="sourceLine" id="cb9-11" title="11">        <span class="co">// send a packet</span></a>
<a class="sourceLine" id="cb9-12" title="12">        Serial &lt;&lt; <span class="st">&quot;..finish sensor capture.&quot;</span> &lt;&lt; mwx::crlf</a>
<a class="sourceLine" id="cb9-13" title="13">            &lt;&lt; <span class="st">&quot;  seq=&quot;</span> &lt;&lt; <span class="dt">int</span>(brd.sns_MC3630.get_que().back().t) </a>
<a class="sourceLine" id="cb9-14" title="14">            &lt;&lt; <span class="st">&quot;/ct=&quot;</span> &lt;&lt; <span class="dt">int</span>(brd.sns_MC3630.get_que().size());</a>
<a class="sourceLine" id="cb9-15" title="15"></a>
<a class="sourceLine" id="cb9-16" title="16">        <span class="co">// calc average in the queue.</span></a>
<a class="sourceLine" id="cb9-17" title="17">        {</a>
<a class="sourceLine" id="cb9-18" title="18">            <span class="dt">int32_t</span> x = <span class="dv">0</span>, y = <span class="dv">0</span>, z = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb9-19" title="19">            <span class="cf">for</span> (<span class="kw">auto</span>&amp;&amp; v: brd.sns_MC3630.get_que()) {</a>
<a class="sourceLine" id="cb9-20" title="20">                x += v.x;</a>
<a class="sourceLine" id="cb9-21" title="21">                y += v.y;</a>
<a class="sourceLine" id="cb9-22" title="22">                z += v.z;</a>
<a class="sourceLine" id="cb9-23" title="23">            }</a>
<a class="sourceLine" id="cb9-24" title="24">            x /= brd.sns_MC3630.get_que().size();</a>
<a class="sourceLine" id="cb9-25" title="25">            y /= brd.sns_MC3630.get_que().size();</a>
<a class="sourceLine" id="cb9-26" title="26">            z /= brd.sns_MC3630.get_que().size();</a>
<a class="sourceLine" id="cb9-27" title="27"></a>
<a class="sourceLine" id="cb9-28" title="28">            Serial &lt;&lt; format(<span class="st">&quot;/ave=</span><span class="sc">%d</span><span class="st">,</span><span class="sc">%d</span><span class="st">,</span><span class="sc">%d</span><span class="st">&quot;</span>, x, y, z) &lt;&lt; mwx::crlf;</a>
<a class="sourceLine" id="cb9-29" title="29">        }</a>
<a class="sourceLine" id="cb9-30" title="30"></a>
<a class="sourceLine" id="cb9-31" title="31">        <span class="cf">for</span> (<span class="dt">int</span> ip = <span class="dv">0</span>; ip &lt; <span class="dv">2</span>; ip++) {</a>
<a class="sourceLine" id="cb9-32" title="32">            <span class="cf">if</span>(<span class="kw">auto</span>&amp;&amp; pkt = </a>
<a class="sourceLine" id="cb9-33" title="33">                the_twelite.network.use&lt;NWK_SIMPLE&gt;().prepare_tx_packet())</a>
<a class="sourceLine" id="cb9-34" title="34">                </a>
<a class="sourceLine" id="cb9-35" title="35">                <span class="co">// set tx packet behavior</span></a>
<a class="sourceLine" id="cb9-36" title="36">                pkt &lt;&lt; tx_addr(<span class="bn">0x00</span>)</a>
<a class="sourceLine" id="cb9-37" title="37">                    &lt;&lt; tx_retry(<span class="bn">0x1</span>)</a>
<a class="sourceLine" id="cb9-38" title="38">                    &lt;&lt; tx_packet_delay(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">2</span>);</a>
<a class="sourceLine" id="cb9-39" title="39">            </a>
<a class="sourceLine" id="cb9-40" title="40">                <span class="co">// prepare packet (first)</span></a>
<a class="sourceLine" id="cb9-41" title="41">                <span class="dt">uint8_t</span> siz = (brd.sns_MC3630.get_que().size() &gt;= MAX_SAMP_IN_PKT)</a>
<a class="sourceLine" id="cb9-42" title="42">                                    ? MAX_SAMP_IN_PKT : brd.sns_MC3630.get_que().size();</a>
<a class="sourceLine" id="cb9-43" title="43">                <span class="dt">uint16_t</span> seq = brd.sns_MC3630.get_que().front().t;</a>
<a class="sourceLine" id="cb9-44" title="44">            </a>
<a class="sourceLine" id="cb9-45" title="45">                pack_bytes(pkt.get_payload()</a>
<a class="sourceLine" id="cb9-46" title="46">                    , make_pair(FOURCHARS, <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb9-47" title="47">                    , seq </a>
<a class="sourceLine" id="cb9-48" title="48">                    , siz</a>
<a class="sourceLine" id="cb9-49" title="49">                );</a>
<a class="sourceLine" id="cb9-50" title="50"></a>
<a class="sourceLine" id="cb9-51" title="51">                <span class="co">// store sensor data (36bits into 5byts, alas 4bits are not used...)</span></a>
<a class="sourceLine" id="cb9-52" title="52">                <span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; siz; i++) {</a>
<a class="sourceLine" id="cb9-53" title="53">                    <span class="kw">auto</span>&amp;&amp; v = brd.sns_MC3630.get_que().front();</a>
<a class="sourceLine" id="cb9-54" title="54">                    <span class="dt">uint32_t</span> v1;</a>
<a class="sourceLine" id="cb9-55" title="55"></a>
<a class="sourceLine" id="cb9-56" title="56">                    v1  = ((<span class="dt">uint16_t</span>(v.x/<span class="dv">2</span>) &amp; <span class="dv">4095</span>) &lt;&lt; <span class="dv">20</span>)  <span class="co">// X:12bits</span></a>
<a class="sourceLine" id="cb9-57" title="57">                        | ((<span class="dt">uint16_t</span>(v.y/<span class="dv">2</span>) &amp; <span class="dv">4095</span>) &lt;&lt;  <span class="dv">8</span>)  <span class="co">// Y:12bits</span></a>
<a class="sourceLine" id="cb9-58" title="58">                        | ((<span class="dt">uint16_t</span>(v.z/<span class="dv">2</span>) &amp; <span class="dv">4095</span>) &gt;&gt;  <span class="dv">4</span>); <span class="co">// Z:8bits from MSB</span></a>
<a class="sourceLine" id="cb9-59" title="59">                    <span class="dt">uint8_t</span> v2 = (<span class="dt">uint16_t</span>(v.z/<span class="dv">2</span>) &amp; <span class="dv">255</span>);   <span class="co">// Z:4bits from LSB</span></a>
<a class="sourceLine" id="cb9-60" title="60">                    pack_bytes(pkt.get_payload(), v1, v2); <span class="co">// add into pacekt entry.</span></a>
<a class="sourceLine" id="cb9-61" title="61">                    brd.sns_MC3630.get_que().pop(); <span class="co">// pop an entry from queue.</span></a>
<a class="sourceLine" id="cb9-62" title="62">                }</a>
<a class="sourceLine" id="cb9-63" title="63"></a>
<a class="sourceLine" id="cb9-64" title="64">                <span class="co">// perform transmit</span></a>
<a class="sourceLine" id="cb9-65" title="65">                MWX_APIRET ret = pkt.transmit();</a>
<a class="sourceLine" id="cb9-66" title="66"></a>
<a class="sourceLine" id="cb9-67" title="67">                <span class="cf">if</span> (ret) {</a>
<a class="sourceLine" id="cb9-68" title="68">                    Serial &lt;&lt; <span class="st">&quot;..txreq(&quot;</span> &lt;&lt; <span class="dt">int</span>(ret.get_value()) &lt;&lt; <span class="ch">&#39;)&#39;</span>;</a>
<a class="sourceLine" id="cb9-69" title="69">                    txid[ip] = ret.get_value() &amp; <span class="bn">0xFF</span>;</a>
<a class="sourceLine" id="cb9-70" title="70">                } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb9-71" title="71">                    sleepNow();</a>
<a class="sourceLine" id="cb9-72" title="72">                }</a>
<a class="sourceLine" id="cb9-73" title="73">            }</a>
<a class="sourceLine" id="cb9-74" title="74">        }</a>
<a class="sourceLine" id="cb9-75" title="75"></a>
<a class="sourceLine" id="cb9-76" title="76">        <span class="co">// finished tx request</span></a>
<a class="sourceLine" id="cb9-77" title="77">        b_transmit = <span class="kw">true</span>;</a>
<a class="sourceLine" id="cb9-78" title="78">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb9-79" title="79">        <span class="cf">if</span>(     the_twelite.tx_status.is_complete(txid[<span class="dv">0</span>])</a>
<a class="sourceLine" id="cb9-80" title="80">             &amp;&amp; the_twelite.tx_status.is_complete(txid[<span class="dv">1</span>]) ) {</a>
<a class="sourceLine" id="cb9-81" title="81"></a>
<a class="sourceLine" id="cb9-82" title="82">            sleepNow();</a>
<a class="sourceLine" id="cb9-83" title="83">        }</a>
<a class="sourceLine" id="cb9-84" title="84">    }</a>
<a class="sourceLine" id="cb9-85" title="85">}</a></code></pre></div>
<p>The <code>b_transmit</code> variable controls the behavior within <code>loop()</code>. After a successful transmission request, this value is set to 1, and the program waits for the packet transmission to complete.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb10-1" title="1">    <span class="cf">if</span> (!b_transmit) {</a></code></pre></div>
<p>First check to see if the sensor is available. Since it is after an interrupted wake-up, it is not normal for it not to be AVAILABLE, and it will go straight to sleep.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb11-1" title="1"><span class="cf">if</span> (!brd.sns_MC3630.available()) {</a>
<a class="sourceLine" id="cb11-2" title="2">    Serial &lt;&lt; <span class="st">&quot;..sensor is not available.&quot;</span> </a>
<a class="sourceLine" id="cb11-3" title="3">            &lt;&lt; mwx::crlf &lt;&lt; mwx::flush;</a>
<a class="sourceLine" id="cb11-4" title="4">    sleepNow();</a>
<a class="sourceLine" id="cb11-5" title="5">}</a></code></pre></div>
<p>It is not used in the wireless transmission packet, but we will check the information on the acceleration taken out.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb12-1" title="1">Serial &lt;&lt; <span class="st">&quot;..finish sensor capture.&quot;</span> &lt;&lt; mwx::crlf</a>
<a class="sourceLine" id="cb12-2" title="2">    &lt;&lt; <span class="st">&quot;  seq=&quot;</span> &lt;&lt; <span class="dt">int</span>(brd.sns_MC3630.get_que().front().t) </a>
<a class="sourceLine" id="cb12-3" title="3">    &lt;&lt; <span class="st">&quot;/ct=&quot;</span> &lt;&lt; <span class="dt">int</span>(brd.sns_MC3630.get_que().size());</a>
<a class="sourceLine" id="cb12-4" title="4"></a>
<a class="sourceLine" id="cb12-5" title="5"><span class="co">// calc average in the queue.</span></a>
<a class="sourceLine" id="cb12-6" title="6">{</a>
<a class="sourceLine" id="cb12-7" title="7">    <span class="dt">int32_t</span> x = <span class="dv">0</span>, y = <span class="dv">0</span>, z = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb12-8" title="8">    <span class="cf">for</span> (<span class="kw">auto</span>&amp;&amp; v: brd.sns_MC3630.get_que()) {</a>
<a class="sourceLine" id="cb12-9" title="9">        x += v.x;</a>
<a class="sourceLine" id="cb12-10" title="10">        y += v.y;</a>
<a class="sourceLine" id="cb12-11" title="11">        z += v.z;</a>
<a class="sourceLine" id="cb12-12" title="12">    }</a>
<a class="sourceLine" id="cb12-13" title="13">    x /= brd.sns_MC3630.get_que().size();</a>
<a class="sourceLine" id="cb12-14" title="14">    y /= brd.sns_MC3630.get_que().size();</a>
<a class="sourceLine" id="cb12-15" title="15">    z /= brd.sns_MC3630.get_que().size();</a>
<a class="sourceLine" id="cb12-16" title="16"></a>
<a class="sourceLine" id="cb12-17" title="17">    Serial &lt;&lt; format(<span class="st">&quot;/ave=</span><span class="sc">%d</span><span class="st">,</span><span class="sc">%d</span><span class="st">,</span><span class="sc">%d</span><span class="st">&quot;</span>, x, y, z) &lt;&lt; mwx::crlf;</a>
<a class="sourceLine" id="cb12-18" title="18">}</a></code></pre></div>
<p>The measurement results of the accelerometer are stored in a FIFO queue obtained by <code>brd.sns_MC3630.get_que()</code>.</p>
<p>The structure <code>axis_xyzt</code> that stores the measurement results of the accelerometer contains the information of three axes (x, y, z) and the sequence number t. The number of samples stored is the size of the queue.</p>
<p>The number of samples stored can be checked by reading the queue size (<code>brd.sns_MC3630.get_que().size()</code>). Normally 28 samples, but it may go a little further due to processing delays, etc. The first sample is taken from <code>front()&#39;. The first sample can be obtained by</code>front()<code>. Its sequential number is</code>front().t`.</p>
<p>Here we will take the average of the samples before taking them out of the queue. Each element of the queue can be accessed with a for statement (<code>for (auto&amp;&amp; v: brd.sns_MC3630.get_que()) { ... }</code>), where <code>v.x, v.y, v.z</code> in the for statement is each element. Here, the sum of each element is calculated, and after the for statement, the average is calculated by dividing by the number of elements.</p>
<p>Next, a packet is generated and a request for transmission is made, but because the data volume is large, the packet is divided into two and transmitted twice. Therefore, the sending process is performed twice in the for statement.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb13-1" title="1">        <span class="cf">for</span> (<span class="dt">int</span> ip = <span class="dv">0</span>; ip &lt; <span class="dv">2</span>; ip++) {</a></code></pre></div>
<p>The number of samples to be included in the packet to be sent and the sample first sequence number are stored in the first part of the packet payload.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb14-1" title="1"><span class="co">// prepare packet (first)</span></a>
<a class="sourceLine" id="cb14-2" title="2"><span class="dt">uint8_t</span> siz = (brd.sns_MC3630.get_que().size() &gt;= MAX_SAMP_IN_PKT)</a>
<a class="sourceLine" id="cb14-3" title="3">? MAX_SAMP_IN_PKT : brd.sns_MC3630.get_que().size();</a>
<a class="sourceLine" id="cb14-4" title="4"><span class="dt">uint16_t</span> seq = brd.sns_MC3630.get_que().front().t;</a>
<a class="sourceLine" id="cb14-5" title="5"></a>
<a class="sourceLine" id="cb14-6" title="6">pack_bytes(pkt.get_payload()</a>
<a class="sourceLine" id="cb14-7" title="7">    , make_pair(FOURCHARS, <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb14-8" title="8">    , seq </a>
<a class="sourceLine" id="cb14-9" title="9">    , siz</a>
<a class="sourceLine" id="cb14-10" title="10">);</a></code></pre></div>
<p>Finally, the acceleration data is stored. While earlier we only referenced each element of the queue to calculate the average value, here we read one sample at a time from the queue and store it in the payload of the packet.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb15-1" title="1"><span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; siz; i++) {</a>
<a class="sourceLine" id="cb15-2" title="2">    <span class="kw">auto</span>&amp;&amp; v = brd.sns_MC3630.get_que().front();</a>
<a class="sourceLine" id="cb15-3" title="3">    <span class="dt">uint32_t</span> v1;</a>
<a class="sourceLine" id="cb15-4" title="4"></a>
<a class="sourceLine" id="cb15-5" title="5">    v1  = ((<span class="dt">uint16_t</span>(v.x/<span class="dv">2</span>) &amp; <span class="dv">4095</span>) &lt;&lt; <span class="dv">20</span>)  <span class="co">// X:12bits</span></a>
<a class="sourceLine" id="cb15-6" title="6">        | ((<span class="dt">uint16_t</span>(v.y/<span class="dv">2</span>) &amp; <span class="dv">4095</span>) &lt;&lt;  <span class="dv">8</span>)  <span class="co">// Y:12bits</span></a>
<a class="sourceLine" id="cb15-7" title="7">        | ((<span class="dt">uint16_t</span>(v.z/<span class="dv">2</span>) &amp; <span class="dv">4095</span>) &gt;&gt;  <span class="dv">4</span>); <span class="co">// Z:8bits from MSB</span></a>
<a class="sourceLine" id="cb15-8" title="8">    <span class="dt">uint8_t</span> v2 = (<span class="dt">uint16_t</span>(v.z/<span class="dv">2</span>) &amp; <span class="dv">255</span>);   <span class="co">// Z:4bits from LSB</span></a>
<a class="sourceLine" id="cb15-9" title="9">    pack_bytes(pkt.get_payload(), v1, v2); <span class="co">// add into pacekt entry.</span></a>
<a class="sourceLine" id="cb15-10" title="10">    brd.sns_MC3630.get_que().pop(); <span class="co">// pop an entry from queue.</span></a>
<a class="sourceLine" id="cb15-11" title="11">}</a></code></pre></div>
<p>Use <code>.front()</code> to read the head of the data queue from the accelerometer. After reading, <code>.pop()</code> is used to release the top of the queue.</p>
<p>The data acquired from the accelerometer is in milli-G units, where 1G is 1000. Since the range is set to ±4G, the data is divided by 2 to be stored within a 12-bit range. To save the number of data, the first 4 bytes store the upper 8 bits of the X, Y and Z axes, and the next 1 byte stores the lower 4 bits of the Z axis, generating a total of 5 bytes.</p>
<p>The transmission ID is stored in the <code>txid[]</code> array to wait for two transmissions.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb16-1" title="1">MWX_APIRET ret = pkt.transmit();</a>
<a class="sourceLine" id="cb16-2" title="2"></a>
<a class="sourceLine" id="cb16-3" title="3"><span class="cf">if</span> (ret) {</a>
<a class="sourceLine" id="cb16-4" title="4">    Serial &lt;&lt; <span class="st">&quot;..txreq(&quot;</span> &lt;&lt; <span class="dt">int</span>(ret.get_value()) &lt;&lt; <span class="ch">&#39;)&#39;</span>;</a>
<a class="sourceLine" id="cb16-5" title="5">    txid[ip] = ret.get_value() &amp; <span class="bn">0xFF</span>;</a>
<a class="sourceLine" id="cb16-6" title="6">} <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb16-7" title="7">    sleepNow();</a>
<a class="sourceLine" id="cb16-8" title="8">}</a></code></pre></div>
<p>Then, if <code>b_transmit</code> is <code>true</code> during <code>loop()</code>, a completion check is performed, and if completed, <code>sleepNow()</code> puts the program to sleep.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb17-1" title="1">} <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb17-2" title="2">    <span class="cf">if</span>(     the_twelite.tx_status.is_complete(txid[<span class="dv">0</span>])</a>
<a class="sourceLine" id="cb17-3" title="3">         &amp;&amp; the_twelite.tx_status.is_complete(txid[<span class="dv">1</span>]) ) {</a>
<a class="sourceLine" id="cb17-4" title="4"></a>
<a class="sourceLine" id="cb17-5" title="5">        sleepNow();</a>
<a class="sourceLine" id="cb17-6" title="6">    }</a>
<a class="sourceLine" id="cb17-7" title="7">}</a></code></pre></div>
<p>The completion of transmission is confirmed by <code>the_twelite.tx_status.is_complete()</code> The <code>.txid[]</code> is the ID value returned on transmission.</p>
</body>
</html>
