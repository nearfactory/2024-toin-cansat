<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Mono Wireless Inc." />
  <title>TwePacketPAL</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <style type="text/css">body { line-height: 1.3em; }
p { line-height: 1.5em; }
img {
display: block;
margin-left: auto;
margin-right: auto;
width: 66%;
}
h1, h2, h3 {
padding: 1em 1em; border-left: 0.5em solid #000;
background: #f4f4f4;
}
h1.title {
all: initial;
font-size: 1em;
border-left: 3em solid #000;
padding: 0em 0.5em 0em 0.5em;
font-weight: bold;
}
p.author, h2.author {
all: initial;
font-size: 1em;
border-left: 0.5em solid #000;
padding: 0em 0.5em 0em 0.5em;
font-weight: bold;
}
p.date, h3.date {
all: initial;
font-size: 1em;
border-left: 0.5em solid #000;
border-right: 10em solid #000;
padding: 0em 0.5em 0em 0.5em;
font-weight: bold;
}
p.caption {
text-align: center;
font-weight: bold;
}
table {
width: 85%;
margin: auto;
border-collapse: collapse;
border-spacing: 4px;
}
pre {
width: 85%;
padding: 0.5em 1em;
margin: auto;
border:1px solid #333;
padding: 4px;
}
td, th {
border-collapse: collapse;
border:1px solid #333;
}
div.success {
width: 90%;
margin: 0.5em 1em;
margin-left: auto;
margin-right: auto;
padding: 0.5em 1em;
border: dashed 2px #408040;
background-color: #e0FFe0;
}
div.warning {
width: 90%;
margin: 0.5em 1em;
margin-left: auto;
margin-right: auto;
padding: 0.5em 1em;
border: dashed 2px #807060;
background-color: #FFF8E8;
}
div.danger {
width: 90%;
margin: 0.5em 1em;
margin-left: auto;
margin-right: auto;
padding: 0.5em 1em;
border: dashed 2px #FF0000;
background-color: #FFE0E0;
}
div.info {
width: 90%;
margin: 0.5em 1em;
margin-left: auto;
margin-right: auto;
padding: 0.5em 1em;
border: dashed 2px #404080;
background-color: #e8e8FF;
}
div.pageref {
padding: 0.5em 1em;
margin: 2em 0;
color: #232323;
background: #fff8e8;
border-left: solid 10px #ffc06e;
}
code {

padding: 0.2em 0.2em 0.2em 0.2em; background: #f0f0f0;
border: solid 1px #808080;
border-radius: 0.2em;
}
pre code {
background: #ffffff;
border: none;
}</style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">TwePacketPAL</h1>
<p class="author">Mono Wireless Inc.</p>
</header>
<nav id="TOC">
<ul>
<li><a href="#twepacketpal">TwePacketPAL</a><ul>
<li><a href="#datapal-structure">DataPal structure</a></li>
<li><a href="#palbase">PalBase</a></li>
<li><a href="#palevent">PalEvent</a></li>
<li><a href="#generator-functions">Generator functions</a><ul>
<li><a href="#get_palmag">get_PalMag()</a></li>
<li><a href="#get_palamb">get_PalAmb()</a></li>
<li><a href="#get_palmot">get_PalMot()</a></li>
<li><a href="#get_palevent">get_PalEvent()</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
<h1 id="twepacketpal">TwePacketPAL</h1>
<p>The <code>TwePacketPal</code> class interprets TWELITE PAL packet data. This class handles TWELITE PAL (sensor data and other upstream data) commonly.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">class</span> TwePacketPal : <span class="kw">public</span> TwePacket, <span class="kw">public</span> DataPal { ... };</a></code></pre></div>
<p>PAL common data is defined in <code>DataPal</code>.</p>
<p>Generator functions are provided to retrieve data specific to each PAL sensor board.</p>
<h3 id="datapal-structure">DataPal structure</h3>
<p>Although the packet data structure of PAL differs depending on the connected sensors, etc., <code>DataPal</code> holds the data structure of the common part.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">struct</span> DataPal {</a>
<a class="sourceLine" id="cb2-2" title="2">    <span class="dt">uint8_t</span> u8lqi; <span class="co">// LQI value</span></a>
<a class="sourceLine" id="cb2-3" title="3"></a>
<a class="sourceLine" id="cb2-4" title="4">    <span class="dt">uint32_t</span> u32addr_rpt; <span class="co">// address of the relay</span></a>
<a class="sourceLine" id="cb2-5" title="5"></a>
<a class="sourceLine" id="cb2-6" title="6">    <span class="dt">uint32_t</span> u32addr_src; <span class="co">// source address</span></a>
<a class="sourceLine" id="cb2-7" title="7">    <span class="dt">uint8_t</span> u8addr_src; <span class="co">// source logical address</span></a>
<a class="sourceLine" id="cb2-8" title="8"></a>
<a class="sourceLine" id="cb2-9" title="9">    <span class="dt">uint16_t</span> u16seq; <span class="co">// sequence number</span></a>
<a class="sourceLine" id="cb2-10" title="10"></a>
<a class="sourceLine" id="cb2-11" title="11">    E_PAL_PCB u8palpcb; <span class="co">// PAL board type</span></a>
<a class="sourceLine" id="cb2-12" title="12">    <span class="dt">uint8_t</span> u8palpcb_rev; <span class="co">// Revision of PAL board</span></a>
<a class="sourceLine" id="cb2-13" title="13">    <span class="dt">uint8_t</span> u8sensors; <span class="co">// Number of sensor data in the data (MSB=1 is an error)</span></a>
<a class="sourceLine" id="cb2-14" title="14">    <span class="dt">uint8_t</span> u8snsdatalen; <span class="co">// sensor data length (in bytes)</span></a>
<a class="sourceLine" id="cb2-15" title="15"></a>
<a class="sourceLine" id="cb2-16" title="16">    <span class="kw">union</span> {</a>
<a class="sourceLine" id="cb2-17" title="17">        <span class="at">const</span> <span class="dt">uint8_t</span> *au8snsdata; <span class="co">// reference to sensor data part</span></a>
<a class="sourceLine" id="cb2-18" title="18">        <span class="dt">uint8_t</span> _pobj[MWX_PARSER_PKT_APPPAL_FIXED_BUF]; <span class="co">// each sensor object</span></a>
<a class="sourceLine" id="cb2-19" title="19">    };</a>
<a class="sourceLine" id="cb2-20" title="20">};</a></code></pre></div>
<p>The PAL packet data structure consists of two blocks: the common part for all PALs and the individual data part. The individual data part does not interpret the packet, but stores it as is. To simplify handling, data exceeding 32 bytes is stored in dynamically allocated <code>uptr_snsdata</code>.</p>
<p>The individual data parts are stored in a structure whose base class is <code>PalBase</code>. This structure is generated by the generator function defined in <code>TwePacketPal</code>.</p>
<p>If the size fits in <code>MWX_PARSER_PKT_APPPAL_FIXED_BUF</code> when <code>parse&lt;TwePacketPAL&gt;()</code> is executed, a separate sensor object is generated.</p>
<p>If it does not fit, a reference to the byte sequence used for analysis is stored in <code>au8snsdata</code>. In this case, if the data in the byte string used for analysis is rewritten, sensor-specific objects cannot be generated.</p>
<h3 id="palbase">PalBase</h3>
<p>All data structures for each sensor in PAL inherit from <code>PalBase</code>. The sensor data storage status <code>u32StoredMask</code> is included.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb3-1" title="1">    <span class="kw">struct</span> PalBase {</a>
<a class="sourceLine" id="cb3-2" title="2">        <span class="dt">uint32_t</span> u32StoredMask; <span class="co">// Data acquisition flags used internally</span></a>
<a class="sourceLine" id="cb3-3" title="3">    };</a></code></pre></div>
<h3 id="palevent">PalEvent</h3>
<p>PAL events are information that is sent when certain conditions are met by processing sensor information, rather than directly from sensors. For example, when an acceleration sensor detects a certain level of acceleration from a stationary state.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb4-1" title="1">    <span class="kw">struct</span> PalEvent {</a>
<a class="sourceLine" id="cb4-2" title="2">        <span class="dt">uint8_t</span> b_stored; <span class="co">// true if stored</span></a>
<a class="sourceLine" id="cb4-3" title="3">        <span class="dt">uint8_t</span> u8event_source; <span class="co">// spare</span></a>
<a class="sourceLine" id="cb4-4" title="4">        <span class="dt">uint8_t</span> u8event_id; <span class="co">// event ID</span></a>
<a class="sourceLine" id="cb4-5" title="5">        <span class="dt">uint32_t</span> u32event_param;<span class="co">// event parameter</span></a>
<a class="sourceLine" id="cb4-6" title="6">    };</a></code></pre></div>
<p>If event data exists, it can be determined by <code>.is_PalEvent()</code> of <code>TwePacketPal</code> being <code>true</code>, and <code>.get_PalEvent()</code> will yield a <code>PalEvent</code> data structure.</p>
<h2 id="generator-functions">Generator functions</h2>
<p>Generator functions are used to extract various types of data from sensor PAL.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb5-1" title="1"><span class="dt">void</span> print_pal(pktparser&amp; pkt) {</a>
<a class="sourceLine" id="cb5-2" title="2">    <span class="kw">auto</span>&amp;&amp; pal = pkt.use&lt;TwePacketPal&gt;();</a>
<a class="sourceLine" id="cb5-3" title="3">    <span class="cf">if</span> (pal.is_PalEvent()) {</a>
<a class="sourceLine" id="cb5-4" title="4">        PalEvent obj = pal.get_PalEvent();</a>
<a class="sourceLine" id="cb5-5" title="5">    } <span class="cf">else</span></a>
<a class="sourceLine" id="cb5-6" title="6">    <span class="cf">switch</span>(pal.u8palpcb) {</a>
<a class="sourceLine" id="cb5-7" title="7">    <span class="cf">case</span> E_PAL_PCB::MAG:</a>
<a class="sourceLine" id="cb5-8" title="8">      {</a>
<a class="sourceLine" id="cb5-9" title="9">          <span class="co">// generate pal board specific data structure.</span></a>
<a class="sourceLine" id="cb5-10" title="10">          PalMag obj = pal.get_PalMag();</a>
<a class="sourceLine" id="cb5-11" title="11">      } <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb5-12" title="12">  <span class="cf">case</span> E_PAL_PCB::AMB:</a>
<a class="sourceLine" id="cb5-13" title="13">      {</a>
<a class="sourceLine" id="cb5-14" title="14">          <span class="co">// generate pal board specific data structure.</span></a>
<a class="sourceLine" id="cb5-15" title="15">          PalAmb obj = pal.get_PalAmb();</a>
<a class="sourceLine" id="cb5-16" title="16">      } <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb5-17" title="17">      ...</a>
<a class="sourceLine" id="cb5-18" title="18">    <span class="cf">default</span>: ;</a>
<a class="sourceLine" id="cb5-19" title="19">    }</a>
<a class="sourceLine" id="cb5-20" title="20">}</a></code></pre></div>
<p>To use the generator function, first determine if <code>pkt</code> is an event (<code>.is_PalEvent()</code>). If it is an event, it has <code>get_PalEvent()</code>. Otherwise, it creates an object according to <code>u8palpcb</code>.</p>
<h3 id="get_palmag">get_PalMag()</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb6-1" title="1">PalMag get_PalMag()</a>
<a class="sourceLine" id="cb6-2" title="2"></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="co">// MAG</span></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="kw">struct</span> PalMag : <span class="kw">public</span> PalBase {</a>
<a class="sourceLine" id="cb6-5" title="5">    <span class="dt">uint16_t</span> u16Volt; <span class="co">// module voltage [mV]</span></a>
<a class="sourceLine" id="cb6-6" title="6">    <span class="dt">uint8_t</span> u8MagStat; <span class="co">// state of magnetic switch [0:no magnet,1,2].</span></a>
<a class="sourceLine" id="cb6-7" title="7">    <span class="dt">uint8_t</span> bRegularTransmit; <span class="co">// MSB flag of u8MagStat</span></a>
<a class="sourceLine" id="cb6-8" title="8">};</a></code></pre></div>
<p>If <code>.u8palpcb==E_PAL_PCB::MAG</code>, the data <code>PalMag</code> of the open/close sensor pal is taken.</p>
<h3 id="get_palamb">get_PalAmb()</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb7-1" title="1">PalAmb get_PalAmb()</a>
<a class="sourceLine" id="cb7-2" title="2"></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="co">// AMB</span></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="kw">struct</span> PalAmb : <span class="kw">public</span> PalBase {</a>
<a class="sourceLine" id="cb7-5" title="5">    <span class="dt">uint16_t</span> u16Volt; <span class="co">// module voltage [mV]</span></a>
<a class="sourceLine" id="cb7-6" title="6">    <span class="dt">int16_t</span> i16Temp; <span class="co">// temperature (100x value)</span></a>
<a class="sourceLine" id="cb7-7" title="7">    <span class="dt">uint16_t</span> u16Humd; <span class="co">// humidity (100x value)</span></a>
<a class="sourceLine" id="cb7-8" title="8">    <span class="dt">uint32_t</span> u32Lumi; <span class="co">// illuminance (equivalent to Lux)</span></a>
<a class="sourceLine" id="cb7-9" title="9">};</a></code></pre></div>
<p>If <code>.u8palpcb==E_PAL_PCB::AMB</code>, the data <code>PalAmb</code> of the environmental sensor pal is taken.</p>
<h3 id="get_palmot">get_PalMot()</h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb8-1" title="1">PalMot get_PalMot()</a>
<a class="sourceLine" id="cb8-2" title="2"></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="co">// MOT</span></a>
<a class="sourceLine" id="cb8-4" title="4"><span class="kw">struct</span> PalMot : <span class="kw">public</span> PalBase {</a>
<a class="sourceLine" id="cb8-5" title="5">    <span class="dt">uint16_t</span> u16Volt; <span class="co">// module voltage [mV]</span></a>
<a class="sourceLine" id="cb8-6" title="6">    <span class="dt">uint8_t</span> u8samples; <span class="co">// number of samples</span></a>
<a class="sourceLine" id="cb8-7" title="7">    <span class="dt">uint8_t</span> u8sample_rate_code; <span class="co">// sample rate (0: 25Hz, 4:100Hz)</span></a>
<a class="sourceLine" id="cb8-8" title="8">    <span class="dt">int16_t</span> i16X[<span class="dv">16</span>]; <span class="co">// X axis</span></a>
<a class="sourceLine" id="cb8-9" title="9">    <span class="dt">int16_t</span> i16Y[<span class="dv">16</span>]; <span class="co">// Y axis</span></a>
<a class="sourceLine" id="cb8-10" title="10">    <span class="dt">int16_t</span> i16Z[<span class="dv">16</span>]; <span class="co">// Z axis</span></a>
<a class="sourceLine" id="cb8-11" title="11">};</a></code></pre></div>
<p>If <code>.u8palpcb==E_PAL_PCB::MOT</code>, the data <code>PalMot</code> of the operating sensor pal is taken.</p>
<h3 id="get_palevent">get_PalEvent()</h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb9-1" title="1">PalEvent get_PalEvent()</a>
<a class="sourceLine" id="cb9-2" title="2"></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="co">// PAL event</span></a>
<a class="sourceLine" id="cb9-4" title="4"><span class="kw">struct</span> PalEvent {</a>
<a class="sourceLine" id="cb9-5" title="5">    <span class="dt">uint8_t</span> b_stored; <span class="co">// if true, event information is available</span></a>
<a class="sourceLine" id="cb9-6" title="6">    <span class="dt">uint8_t</span> u8event_source; <span class="co">// event source</span></a>
<a class="sourceLine" id="cb9-7" title="7">    <span class="dt">uint8_t</span> u8event_id; <span class="co">// event ID</span></a>
<a class="sourceLine" id="cb9-8" title="8">    <span class="dt">uint32_t</span> u32event_param; <span class="co">// 24bit, event parameter</span></a>
<a class="sourceLine" id="cb9-9" title="9">};</a></code></pre></div>
<p>Extracts a <code>PalEvent</code> (PAL event) if <code>.is_PalEvent()</code> is <code>true</code>.</p>
</body>
</html>
